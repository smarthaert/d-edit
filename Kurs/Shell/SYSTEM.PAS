Uses CRT,DOS;

{ ษอัอออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออัอป }
{ บ ณ                                      ณ บ }
{ ศอฯอออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออฯอผ }

{ ---=== ค็ ===--- }
 Type
   PTask = ^TTask;
   TTask = Object
     Name : String[32]; { ฌ๏ งค็จ }
     Numb : Word; { ฎฌฅเ งค็จ แ โชจฌ จฌฅญฅฌ }
     Next : PTask; { ซฅคใ๎้๏ งค็ ข แฏจแชฅ }
     Constructor Create;
     Procedure Init; Virtual;
     Procedure Run;  Virtual;
     Procedure Done; Virtual;
     Procedure CloseTask;
   End;

{ ---=== ฏจแฎช งค็ ===--- }
 Const FirstTask : PTask = nil;
       LastTask  : PTask = nil;

{ ---=== ฅญฅคฆฅเ งค็ ===--- }
 Type
   TTaskManager = Object
     Procedure AddTask( TaskName:String );
     Procedure DelTask( TaskName:String; Numb:Word );
     Procedure DelAllTasks;
     Procedure Run;
   End;

 Var TaskManager : TTaskManager;

{ ---=== ขฅเ่ฅญจฅ เกฎโ๋ แจแโฅฌ๋ ===--- }
 Const ShutDownSystem : Boolean = False;

{ ษอัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออัอป }
{ บ ณ                                                 ณ บ }
{ ศอฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออฯอผ }

{ ---=== ๋ๅฎค ฏฎ ESC ===--- }
 Type
   PEscapeTask = ^TEscapeTask;
   TEscapeTask = Object(TTask)
     Procedure Init; Virtual;
     Procedure Run;  Virtual;
     Procedure Done; Virtual;
   End;

 Procedure TEscapeTask.Init;
   Begin
     Randomize;
     Writeln('[1] โชเ๋ขฅโแ๏ ฏเจซฎฆฅญจฅ ...');
   End;

 Procedure TEscapeTask.Run;
   Begin
     Write('[2] เจซฎฆฅญจฅ เกฎโฅโ ',Random(5),#13);
     If KeyPressed then
       If ReadKey = #27 then
         ShutDownSystem:=True;
   End;

 Procedure TEscapeTask.Done;
   Begin
     Writeln;
     Writeln('[3] ชเ๋ขฅโแ๏ ฏเจซฎฆฅญจฅ ...');
   End;

{ ---=== ฅฃจแโเๆจฎญญ๋ฉ แฏจแฎช งค็ ===--- }
 Function TaskType( TaskName:String ):PTask;
   Begin
     If TaskName = 'ESCAPE' then TaskType:=New(PEscapeTask,Create) Else
     TaskType:=nil;
   End;

{ ษอัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออัอป }
{ บ ณ                                      ณ บ }
{ ศอฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออฯอผ }

{ ---=== TTask ===--- }
 Constructor TTask.Create; Begin End;
 Procedure TTask.Init; Begin End;
 Procedure TTask.Run;  Begin End;
 Procedure TTask.Done; Begin End;
 Procedure TTask.CloseTask; Begin TaskManager.DelTask(Name,Numb); End;

{ ---=== ฎกขจโ์ งค็ใ ===--- }
 Procedure TTaskManager.AddTask( TaskName:String );
   Var Num:Word; Task:PTask;
   Begin
    { ฎคแ็ฅโ งค็ }
     Num:=1;
     Task:=FirstTask;
     While Task <> nil do
       Begin
         If Task^.Name = TaskName then Inc(Num);
         Task:=Task^.Next;
       End;
    { จฏ งค็จ }
     Task:=TaskType(TaskName);
     If Task = nil then Exit;
    { ฎกขซฅญจฅ งค็จ }
     If FirstTask=nil then FirstTask:=Task;
     If LastTask<>nil then LastTask^.Next:=Task;
     LastTask:=Task;
     LastTask^.Numb:=Num;
     LastTask^.Next:=nil;
     LastTask^.Init;
   End;

{ ---=== ขฅเ่จโ์ งค็ใ ===--- }
 Procedure TTaskManager.DelTask( TaskName:String; Numb:Word );
   Var Task,Prev:PTask;
   Begin
     Task:=FirstTask;
     Prev:=nil;
     While Task<>nil do
       Begin
         If Task^.Name = TaskName then
           Begin
             If Task^.Numb = Numb then
               Begin
                 If Prev<>nil then
                   Prev^.Next:=Task^.Next
                 Else
                   FirstTask:=Task^.Next;
                 Task^.Done;
                 Dispose(Task);
               End;
             If Task^.Numb > Numb then Dec(Task^.Numb);
           End;
         Prev:=Task;
         Task:=Task^.Next;
       End;
   End;

{ ---=== ญ๏โ์ ขแฅ งค็จ ===--- }
 Procedure TTaskManager.DelAllTasks;
   Var Task,Next:PTask;
   Begin
     Task:=FirstTask;
     While Task<>nil do
       Begin
         Next:=Task^.Next;
         Task^.Done;
         Dispose(Task);
         Task:=Next;
       End;
   End;

{ ---=== ฏใแช งค็ ===--- }
 Procedure TTaskManager.Run;
   Var Task:PTask;
   Begin
     Task:=FirstTask;
     While Task<>nil do
       Begin
         Task^.Run;
         Task:=Task^.Next;
       End;
   End;

{ ษอัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออัอป }
{ บ ณ                                             ณ บ }
{ ศอฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออฯอผ }
Begin
  TaskManager.AddTask('ESCAPE');
  Repeat
    TaskManager.Run;
  Until ShutDownSystem;
  TaskManager.DelAllTasks;
End.