Unit Tasks;

Interface

{ ษอัอออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออัอป }
{ บ ณ                                                  ณ บ }
{ ศอฯอออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออฯอผ }

{ --=== ค็ ===-- }
 Type
   PTask = ^TTask;
   TTask = Object
     Name : String[32]; { ฌ๏ งค็จ }
     Numb : Word; { ฎฌฅเ งค็จ แ โชจฌ จฌฅญฅฌ }
     Next : PTask; { ซฅคใ๎้๏ งค็ ข แฏจแชฅ }
     Constructor Create;
     Procedure Init; Virtual;
     Procedure Run;  Virtual;
     Procedure Done; Virtual;
     Procedure CloseTask;
   End;

{ --=== ฅญฅคฆฅเ งค็ ===-- }
 Type
   TTaskManager = Object
     Procedure AddTask( TaskName:String );
     Procedure DelTask( TaskName:String; Numb:Word );
     Procedure DelAllTasks;
     Procedure Run;
   End;

 Var TaskManager : TTaskManager; { ฎกแโขฅญญฎ ฎก์ฅชโ ฌฅญฅคฆฅเ }

{ --=== ขฅเ่ฅญจฅ เกฎโ๋ แจแโฅฌ๋ ===-- }
 Const ShutDownSystem : Boolean = False;

{ ษอัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออัอป }
{ บ ณ                       C                                ณ บ }
{ ศอฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออฯอผ }

{ ---=== ฎฎก้ฅญจฅ ===--- }
 Type
   PMessage = ^TMessage;
   TMessage = Record
     Mesg : String[78];
     Next : PMessage;
   End;

{ ---=== ฎขฎฅ แฎฎก้ฅญจฅ ===--- }
 Procedure Message( _Message_:String );

Implementation

{ แฅ จแฏฎซ์งใฅฌ๋ฅ ฎคใซจ }
Uses _LOG_;

{ ษอัอออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออัอป }
{ บ ณ                                                  ณ บ }
{ ศอฯอออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออฯอผ }

{ --=== ฏจแฎช งค็ ===-- }
 Const FirstTask : PTask = nil;
       LastTask  : PTask = nil;

{ ---=== TTask ===--- }
 Constructor TTask.Create; Begin End;
 Procedure TTask.Init; Begin End;
 Procedure TTask.Run;  Begin End;
 Procedure TTask.Done; Begin End;
 Procedure TTask.CloseTask; Begin TaskManager.DelTask(Name,Numb); End;

{ ---=== ฎกขจโ์ งค็ใ ===--- }
 Procedure TTaskManager.AddTask( TaskName:String );
   Var Num:Word; Task:PTask;
   Begin
     Writeln(LOG,'[TaskManager.AddTask]: ฎกขซ๏ฅโแ๏ งค็ '+TaskName);
    { ฎคแ็ฅโ งค็ }
     Num:=1;
     Task:=FirstTask;
     While Task <> nil do
       Begin
         If Task^.Name = TaskName then Inc(Num);
         Task:=Task^.Next;
       End;
    { จฏ งค็จ }
     Task:=TaskType(TaskName);
     If Task = nil then
       Begin
         Writeln(LOG,'[TaskManager.AddTask]: ฎกขซฅญจฅ ญฅจงขฅแโญฎฃฎ โจฏ งค็จ '+TaskName);
         Exit;
       End;
    { ฎกขซฅญจฅ งค็จ }
     If FirstTask=nil then FirstTask:=Task;
     If LastTask<>nil then LastTask^.Next:=Task;
     LastTask:=Task;
     LastTask^.Numb:=Num;
     LastTask^.Next:=nil;
     LastTask^.Name:=TaskName;
     LastTask^.Init;
   End;

{ ---=== ขฅเ่จโ์ งค็ใ ===--- }
 Procedure TTaskManager.DelTask( TaskName:String; Numb:Word );
   Var Task,Prev:PTask;
   Begin
     Writeln(LOG,'[TaskManager.DelTask]: ญจฌฅโแ๏ งค็ '+TaskName);
     Task:=FirstTask;
     Prev:=nil;
     While Task<>nil do
       Begin
         If Task^.Name = TaskName then
           Begin
             If Task^.Numb = Numb then
               Begin
                 If Prev<>nil then
                   Prev^.Next:=Task^.Next
                 Else
                   FirstTask:=Task^.Next;
                 Task^.Done;
                 Dispose(Task);
               End;
             If Task^.Numb > Numb then Dec(Task^.Numb);
           End;
         Prev:=Task;
         Task:=Task^.Next;
       End;
   End;

{ ---=== ญ๏โ์ ขแฅ งค็จ ===--- }
 Procedure TTaskManager.DelAllTasks;
   Var Task,Next:PTask;
   Begin
     Writeln(LOG,'[TaskManager.DelAllTasks]: ญจฌ๎โแ๏ ขแฅ งค็จ ');
     Task:=FirstTask;
     While Task<>nil do
       Begin
         Next:=Task^.Next;
         Task^.Done;
         Dispose(Task);
         Task:=Next;
       End;
   End;

{ ---=== ฏใแช งค็ ===--- }
 Procedure TTaskManager.Run;
   Var Task:PTask;
   Begin
     Task:=FirstTask;
     While Task<>nil do
       Begin
         Task^.Run;
         Task:=Task^.Next;
       End;
   End;

{ ษอัออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออัอป }
{ บ ณ                       C                                ณ บ }
{ ศอฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออฯอผ }

{ ---=== ใไฅเ แฎฎก้ฅญจฉ ===--- }
 Const MessageList : PMessage = nil;

{ ---=== ฎขฎฅ แฎฎก้ฅญจฅ ===--- }
 Procedure Message( _Message_:String );
   Var Last,Mesg:PMessage;
   Begin
     Writeln(Log,'# '+_Message_);
     New(Mesg);
     Mesg^.Mesg:=_Message_;
     Mesg^.Next:=nil;
     If MessageList<>nil then
       Begin
         Last:=MessageList;
         While Last^.Next<>nil do Last:=Last^.Next;
         Last^.Next:=Mesg;
       End
     Else
       MessageList:=Mesg;
   End;

{ ---=== งขซฅ็์ แฎฎก้ฅญจฅ ===--- }
 Function GetMessage:String;
   Var Mesg:PMessage;
   Begin
     GetMessage:=MessageList^.Mesg;
     Mesg:=MessageList^.Next;
     Dispose(MessageList);
     MessageList:=Mesg;
   End;

{ ---=== กเกฎโช แฎฎก้ฅญจฉ ===--- }
 Type
   PMessageTask = ^TMessageTask;
   TMessageTask = Object(TTask)
     OutX,OutY : Byte;
     Procedure Init; Virtual;
     Procedure Run; Virtual;
     Procedure Done; Virtual;
   End;

 Procedure TMessageTask.Init;
   Begin
     DrawBorder(1,1,80,21,5);
     Message(' ษออออออออออออออออออออออออออออออออออออออออออออป');
     Message(' บ  ---=== Super Contest Server v0.99 ===---  บ');
     Message(' บ      (c) Roman International Software      บ');
     Message(' บ            Build 001 [04.12.99]            บ');
     Message(' ศออออออออออออออออออออออออออออออออออออออออออออผ');
     Message('    ฏจแ์ ข ไฉซ : '+LogFileName);
     Message('~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~');
     Message('');
   End;

 Procedure TMessageTask.Run;
   Var X,Y:Byte; S:String;
   Begin
     If MessageList = nil then Exit;
     X:=WhereX; Y:=WhereY;
     TextColor(3);
     Window(2,2,79,20);
     GotoXY(OutX,OutY);
     While MessageList<>nil do
       Begin
         S:=GetMessage;
         Writeln(S);
       End;
     OutX:=WhereX;
     OutY:=WhereY;
     Window(1,1,80,25);
     GotoXY(X,Y);
   End;

 Procedure TMessageTask.Done;
   Begin
     Run;
   End;

End.

